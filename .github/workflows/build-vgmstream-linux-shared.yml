name: Build vgmstream Linux shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-linux-shared.yml'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev

      - name: Configure
        run: |
          cmake -S external/vgmstream -B build-vgmstream-linux \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        run: |
          cmake --build build-vgmstream-linux -j$(nproc)

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts/deps
          cp -f build-vgmstream-linux/src/libvgmstream.so* artifacts/

          if [ -d /usr/lib/x86_64-linux-gnu ]; then
            cp -L /usr/lib/x86_64-linux-gnu/libogg.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libvorbis.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libvorbisfile.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libmpg123.so* artifacts/deps/ || true
          fi

          ls -la artifacts
          ls -la artifacts/deps || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-linux-shared
          path: artifacts/
          retention-days: 30
