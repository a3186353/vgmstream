name: Build vgmstream macOS shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-macos-shared.yml'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew update
          brew install cmake pkg-config libvorbis mpg123

      - name: Configure
        run: |
          BREW_PREFIX="$(brew --prefix)"
          echo "brew prefix: ${BREW_PREFIX}"

          echo "mpg123 prefix: $(brew --prefix mpg123)"
          ls -la "$(brew --prefix mpg123)/lib" || true

          pkg-config --version || true
          pkg-config --modversion ogg || true
          pkg-config --modversion vorbis || true
          pkg-config --modversion vorbisfile || true

          cmake -S external/vgmstream -B build-vgmstream-macos \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_VERBOSE_MAKEFILE=ON \
            -DCMAKE_PREFIX_PATH="${BREW_PREFIX}" \
            -DMPG123_DIR="$(brew --prefix mpg123)" \
            -DMPG123_INCLUDE_DIR="$(brew --prefix mpg123)/include" \
            -DMPG123_LIBRARIES="$(brew --prefix mpg123)/lib/libmpg123.dylib" \
            -DOGG_ROOT="$(brew --prefix libogg)" \
            -DVORBIS_ROOT="$(brew --prefix libvorbis)" \
            -DVORBISFILE_ROOT="$(brew --prefix libvorbis)" \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        continue-on-error: true
        id: build
        run: |
          cmake --build build-vgmstream-macos -j$(sysctl -n hw.ncpu) --verbose

      - name: Debug Build
        if: always()
        run: |
          echo "===== CMakeCache (filtered) ====="
          if [ -f build-vgmstream-macos/CMakeCache.txt ]; then
            grep -E '^(CMAKE_PREFIX_PATH|CMAKE_LIBRARY_PATH|CMAKE_INCLUDE_PATH|MPG123_|OGG_|VORBIS|VORBISFILE)\b' build-vgmstream-macos/CMakeCache.txt || true
          fi

          echo "===== link.txt (if exists) ====="
          if [ -f build-vgmstream-macos/src/CMakeFiles/libvgmstream_shared.dir/link.txt ]; then
            cat build-vgmstream-macos/src/CMakeFiles/libvgmstream_shared.dir/link.txt
          fi

          echo "===== library dirs ====="
          ls -la "$(brew --prefix mpg123)/lib" || true
          ls -la "$(brew --prefix libogg)/lib" || true
          ls -la "$(brew --prefix libvorbis)/lib" || true

      - name: Fail If Build Failed
        if: steps.build.outcome != 'success'
        run: exit 1

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts/deps
          cp -f build-vgmstream-macos/src/libvgmstream.dylib artifacts/

          cp "$(brew --prefix libvorbis)/lib/libvorbis.dylib" artifacts/deps/ || true
          cp "$(brew --prefix libogg)/lib/libogg.dylib" artifacts/deps/ || true
          cp "$(brew --prefix mpg123)/lib/libmpg123.dylib" artifacts/deps/ || true

          ls -la artifacts
          ls -la artifacts/deps

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-macos-shared
          path: artifacts/
          retention-days: 30
