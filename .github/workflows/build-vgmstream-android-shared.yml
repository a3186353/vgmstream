name: Build vgmstream Android shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-android-shared.yml'

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config autoconf automake libtool libtool-bin m4 gettext gawk

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        env:
          NDK_VERSION: 26.2.11394342
        run: |
          yes | sdkmanager --licenses >/dev/null
          sdkmanager --install "platforms;android-21" "ndk;${NDK_VERSION}"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Build ABIs
        run: |
          set -euo pipefail
          rm -rf artifacts
          mkdir -p artifacts/lib/android

          for ABI in arm64-v8a armeabi-v7a x86 x86_64; do
            BUILD_DIR="build-vgmstream-android-${ABI}"
            cmake -S external/vgmstream -B "${BUILD_DIR}" -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" \
              -DANDROID_ABI="${ABI}" \
              -DANDROID_PLATFORM=android-21 \
              -DANDROID_STL=c++_static \
              -DUSE_VORBIS=ON \
              -DUSE_MPEG=ON \
              -DUSE_FFMPEG=OFF \
              -DUSE_CELT=OFF \
              -DUSE_ATRAC9=OFF \
              -DUSE_SPEEX=OFF \
              -DUSE_G719=OFF \
              -DUSE_G7221=ON \
              -DBUILD_CLI=OFF \
              -DBUILD_V123=OFF \
              -DBUILD_AUDACIOUS=OFF \
              -DBUILD_SHARED_LIBS=ON

            cmake --build "${BUILD_DIR}"

            echo "NEEDED for ${ABI}:"
            readelf -d "${BUILD_DIR}/src/libvgmstream.so" | grep NEEDED || true
            if readelf -d "${BUILD_DIR}/src/libvgmstream.so" | grep -E 'NEEDED.*(libvorbisfile\.so|libvorbis\.so|libogg\.so)'; then
              echo "ERROR: libvgmstream.so still dynamically depends on ogg/vorbis"
              exit 1
            fi

            mkdir -p "artifacts/lib/android/${ABI}"
            cp -f "${BUILD_DIR}/src/libvgmstream.so" "artifacts/lib/android/${ABI}/"
          done

          find artifacts -type f -print

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-android-shared
          path: artifacts/
          retention-days: 30
