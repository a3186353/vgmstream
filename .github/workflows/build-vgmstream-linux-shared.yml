name: Build vgmstream Linux shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-linux-shared.yml'

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
          - arch: aarch64
            runs_on: ubuntu-latest
    runs-on: ${{ matrix.runs_on }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        if: matrix.arch == 'x86_64'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev

      - name: Install Dependencies (aarch64 cross)
        if: matrix.arch == 'aarch64'
        id: cross_deps
        continue-on-error: true
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake pkg-config \
            crossbuild-essential-arm64 pkg-config-aarch64-linux-gnu \
            libvorbis-dev:arm64 libogg-dev:arm64 libmpg123-dev:arm64

      - name: Configure
        if: matrix.arch == 'x86_64'
        run: |
          cmake -S external/vgmstream -B build-vgmstream-linux-x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        if: matrix.arch == 'x86_64'
        run: |
          cmake --build build-vgmstream-linux-x86_64 -j$(nproc)

      - name: Configure (aarch64 cross)
        if: matrix.arch == 'aarch64'
        id: cross_config
        continue-on-error: true
        run: |
          export PKG_CONFIG_LIBDIR="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
          cmake -S external/vgmstream -B build-vgmstream-linux-aarch64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
            -DPKG_CONFIG_EXECUTABLE=aarch64-linux-gnu-pkg-config \
            -DCMAKE_FIND_ROOT_PATH="/usr/aarch64-linux-gnu;/usr/lib/aarch64-linux-gnu" \
            -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
            -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
            -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build (aarch64 cross)
        if: matrix.arch == 'aarch64'
        id: cross_build
        continue-on-error: true
        run: |
          cmake --build build-vgmstream-linux-aarch64 -j$(nproc)

      - name: Set up QEMU (fallback)
        if: matrix.arch == 'aarch64' && steps.cross_build.outcome != 'success'
        uses: docker/setup-qemu-action@v3

      - name: Build (aarch64 qemu fallback)
        if: matrix.arch == 'aarch64' && steps.cross_build.outcome != 'success'
        run: |
          docker run --rm --platform linux/arm64 \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            ubuntu:24.04 \
            bash -lc "\
              apt-get update && \
              apt-get install -y build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev && \
              cmake -S external/vgmstream -B build-vgmstream-linux-aarch64 \
                -DCMAKE_BUILD_TYPE=Release \
                -DUSE_VORBIS=ON \
                -DUSE_MPEG=ON \
                -DUSE_FFMPEG=OFF \
                -DUSE_CELT=OFF \
                -DUSE_ATRAC9=OFF \
                -DUSE_SPEEX=OFF \
                -DUSE_G719=OFF \
                -DUSE_G7221=ON \
                -DBUILD_CLI=OFF \
                -DBUILD_V123=OFF \
                -DBUILD_AUDACIOUS=OFF \
                -DBUILD_SHARED_LIBS=ON && \
              cmake --build build-vgmstream-linux-aarch64 -j2 \
            "

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts/deps
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            BUILD_DIR="build-vgmstream-linux-x86_64"
          else
            BUILD_DIR="build-vgmstream-linux-aarch64"
          fi
          cp -f "${BUILD_DIR}/src/libvgmstream.so" artifacts/

          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            cp -L /usr/lib/x86_64-linux-gnu/libogg.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libvorbis.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libvorbisfile.so* artifacts/deps/ || true
            cp -L /usr/lib/x86_64-linux-gnu/libmpg123.so* artifacts/deps/ || true
          else
            cp -L /usr/lib/aarch64-linux-gnu/libogg.so* artifacts/deps/ || true
            cp -L /usr/lib/aarch64-linux-gnu/libvorbis.so* artifacts/deps/ || true
            cp -L /usr/lib/aarch64-linux-gnu/libvorbisfile.so* artifacts/deps/ || true
            cp -L /usr/lib/aarch64-linux-gnu/libmpg123.so* artifacts/deps/ || true
          fi

          ls -la artifacts
          ls -la artifacts/deps || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-linux-${{ matrix.arch }}-shared
          path: artifacts/
          retention-days: 30
