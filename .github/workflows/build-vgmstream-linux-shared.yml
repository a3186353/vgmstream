name: Build vgmstream Linux shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-linux-shared.yml'

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
          - arch: aarch64
            runs_on: ubuntu-24.04-arm64
    runs-on: ${{ matrix.runs_on }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev

      - name: Configure
        run: |
          cmake -S external/vgmstream -B build-vgmstream-linux \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        run: |
          cmake --build build-vgmstream-linux -j$(nproc)

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts/deps
          cp -f build-vgmstream-linux/src/libvgmstream.so* artifacts/

          ARCH="$(uname -m)"
          if [ "${ARCH}" = "x86_64" ] && [ -d /usr/lib/x86_64-linux-gnu ]; then
            LIBDIR="/usr/lib/x86_64-linux-gnu"
          elif [ "${ARCH}" = "aarch64" ] && [ -d /usr/lib/aarch64-linux-gnu ]; then
            LIBDIR="/usr/lib/aarch64-linux-gnu"
          else
            LIBDIR="/usr/lib"
          fi

          cp -L "${LIBDIR}"/libogg.so* artifacts/deps/ || true
          cp -L "${LIBDIR}"/libvorbis.so* artifacts/deps/ || true
          cp -L "${LIBDIR}"/libvorbisfile.so* artifacts/deps/ || true
          cp -L "${LIBDIR}"/libmpg123.so* artifacts/deps/ || true

          ls -la artifacts
          ls -la artifacts/deps || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-linux-${{ matrix.arch }}-shared
          path: artifacts/
          retention-days: 30
