name: Build vgmstream Linux shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-linux-shared.yml'

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runs_on: ubuntu-latest
          - arch: aarch64
            runs_on: ubuntu-latest
    runs-on: ${{ matrix.runs_on }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        if: matrix.arch == 'x86_64'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev

      - name: Install Dependencies (aarch64 cross)
        if: matrix.arch == 'aarch64'
        run: |
          echo "Skip cross toolchain; use docker+qemu instead"

      - name: Configure
        if: matrix.arch == 'x86_64'
        run: |
          cmake -S external/vgmstream -B build-vgmstream-linux-x86_64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        if: matrix.arch == 'x86_64'
        run: |
          cmake --build build-vgmstream-linux-x86_64 -j$(nproc)

      - name: Configure (aarch64 cross)
        if: matrix.arch == 'aarch64'
        run: |
          echo "Skip cross configure; use docker+qemu instead"

      - name: Build (aarch64 cross)
        if: matrix.arch == 'aarch64'
        run: |
          echo "Skip cross build; use docker+qemu instead"

      - name: Set up QEMU
        if: matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3

      - name: Build (aarch64 qemu)
        if: matrix.arch == 'aarch64'
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          rm -rf artifacts
          mkdir -p artifacts/deps
          docker run --rm --platform linux/arm64 \
            -v "${GITHUB_WORKSPACE}:/work" \
            -w /work \
            ubuntu:24.04 \
            bash -lc "\
              set -euo pipefail && \
              export DEBIAN_FRONTEND=noninteractive && \
              apt-get update && \
              apt-get install -y --no-install-recommends build-essential cmake pkg-config libvorbis-dev libogg-dev libmpg123-dev ca-certificates && \
              cmake -S /work/external/vgmstream -B /tmp/build-vgmstream-linux-aarch64 \
                -DCMAKE_BUILD_TYPE=Release \
                -DUSE_VORBIS=ON \
                -DUSE_MPEG=ON \
                -DUSE_FFMPEG=OFF \
                -DUSE_CELT=OFF \
                -DUSE_ATRAC9=OFF \
                -DUSE_SPEEX=OFF \
                -DUSE_G719=OFF \
                -DUSE_G7221=ON \
                -DBUILD_CLI=OFF \
                -DBUILD_V123=OFF \
                -DBUILD_AUDACIOUS=OFF \
                -DBUILD_SHARED_LIBS=ON && \
              cmake --build /tmp/build-vgmstream-linux-aarch64 -j2 && \
              cp -f /tmp/build-vgmstream-linux-aarch64/src/libvgmstream.so /work/artifacts/ && \
              cp -L /usr/lib/aarch64-linux-gnu/libogg.so* /work/artifacts/deps/ || true && \
              cp -L /usr/lib/aarch64-linux-gnu/libvorbis.so* /work/artifacts/deps/ || true && \
              cp -L /usr/lib/aarch64-linux-gnu/libvorbisfile.so* /work/artifacts/deps/ || true && \
              cp -L /usr/lib/aarch64-linux-gnu/libmpg123.so* /work/artifacts/deps/ || true \
            "

      - name: Collect Artifacts
        if: matrix.arch == 'x86_64'
        run: |
          mkdir -p artifacts/deps
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
            BUILD_DIR="build-vgmstream-linux-x86_64"
          else
            BUILD_DIR="build-vgmstream-linux-aarch64"
          fi
          cp -f "${BUILD_DIR}/src/libvgmstream.so" artifacts/

          cp -L /usr/lib/x86_64-linux-gnu/libogg.so* artifacts/deps/ || true
          cp -L /usr/lib/x86_64-linux-gnu/libvorbis.so* artifacts/deps/ || true
          cp -L /usr/lib/x86_64-linux-gnu/libvorbisfile.so* artifacts/deps/ || true
          cp -L /usr/lib/x86_64-linux-gnu/libmpg123.so* artifacts/deps/ || true

          ls -la artifacts
          ls -la artifacts/deps || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-linux-${{ matrix.arch }}-shared
          path: artifacts/
          retention-days: 30
