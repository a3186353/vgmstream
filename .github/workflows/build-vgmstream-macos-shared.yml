name: Build vgmstream macOS shared

on:
  workflow_dispatch:
  push:
    paths:
      - 'external/vgmstream/**'
      - '.github/workflows/build-vgmstream-macos-shared.yml'

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew update
          brew install cmake pkg-config libvorbis mpg123

      - name: Configure
        run: |
          BREW_PREFIX="$(brew --prefix)"

          cmake -S external/vgmstream -B build-vgmstream-macos \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${BREW_PREFIX}" \
            -DMPG123_DIR="$(brew --prefix mpg123)" \
            -DMPG123_INCLUDE_DIR="$(brew --prefix mpg123)/include" \
            -DMPG123_LIBRARIES="$(brew --prefix mpg123)/lib/libmpg123.dylib" \
            -DOGG_ROOT="$(brew --prefix libogg)" \
            -DVORBIS_ROOT="$(brew --prefix libvorbis)" \
            -DVORBISFILE_ROOT="$(brew --prefix libvorbis)" \
            -DUSE_VORBIS=ON \
            -DUSE_MPEG=ON \
            -DUSE_FFMPEG=OFF \
            -DUSE_CELT=OFF \
            -DUSE_ATRAC9=OFF \
            -DUSE_SPEEX=OFF \
            -DUSE_G719=OFF \
            -DUSE_G7221=ON \
            -DBUILD_CLI=OFF \
            -DBUILD_V123=OFF \
            -DBUILD_AUDACIOUS=OFF \
            -DBUILD_SHARED_LIBS=ON

      - name: Build
        run: |
          cmake --build build-vgmstream-macos -j$(sysctl -n hw.ncpu)

      - name: Collect Artifacts
        run: |
          rm -rf artifacts
          mkdir -p artifacts/lib/macos/deps
          cp -f build-vgmstream-macos/src/libvgmstream.dylib artifacts/lib/macos/

          cp "$(brew --prefix libvorbis)/lib/libvorbis.dylib" artifacts/lib/macos/deps/ || true
          cp "$(brew --prefix libogg)/lib/libogg.dylib" artifacts/lib/macos/deps/ || true
          cp "$(brew --prefix mpg123)/lib/libmpg123.dylib" artifacts/lib/macos/deps/ || true

          ls -la artifacts
          ls -la artifacts/lib/macos/deps

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vgmstream-macos-shared
          path: artifacts/
          retention-days: 30
